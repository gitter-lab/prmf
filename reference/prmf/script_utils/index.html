



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Script Utils - prmf</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="lightgreen">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#module-prmfscript_utils" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="prmf" aria-label="prmf" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              prmf
            </span>
            <span class="md-header-nav__topic">
              
                Script Utils
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/gitter-lab/prmf/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    prmf
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="prmf" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    prmf
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/gitter-lab/prmf/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    prmf
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-1">
      Prmf
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Prmf
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ampl/" title="Ampl" class="md-nav__link">
      Ampl
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ensembl/" title="Ensembl" class="md-nav__link">
      Ensembl
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../image_processing/" title="Image Processing" class="md-nav__link">
      Image Processing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../intersect/" title="Intersect" class="md-nav__link">
      Intersect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../plot/" title="Plot" class="md-nav__link">
      Plot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../prmf_args/" title="Prmf Args" class="md-nav__link">
      Prmf Args
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Script Utils
      </label>
    
    <a href="./" title="Script Utils" class="md-nav__link md-nav__link--active">
      Script Utils
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add_file_and_dir_args" class="md-nav__link">
    add_file_and_dir_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#args_to_list" class="md-nav__link">
    args_to_list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bfs_nodes" class="md-nav__link">
    bfs_nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check_file_and_dir_args" class="md-nav__link">
    check_file_and_dir_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#format_vars" class="md-nav__link">
    format_vars
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#returns" class="md-nav__link">
    Returns
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get_condor_submit_fp" class="md-nav__link">
    get_condor_submit_fp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get_exe_path" class="md-nav__link">
    get_exe_path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_revision_number" class="md-nav__link">
    get_revision_number
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#raises" class="md-nav__link">
    Raises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#job_attrs_to_job_name" class="md-nav__link">
    job_attrs_to_job_name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log_script" class="md-nav__link">
    log_script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters_1" class="md-nav__link">
    Parameters
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mkdir_p" class="md-nav__link">
    mkdir_p
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse_condor_submit_stdout" class="md-nav__link">
    parse_condor_submit_stdout
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#returns_1" class="md-nav__link">
    Returns
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo_1" class="md-nav__link">
    TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_command" class="md-nav__link">
    run_command
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keyword-arguments" class="md-nav__link">
    Keyword Arguments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo_2" class="md-nav__link">
    TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_command_cp" class="md-nav__link">
    run_command_cp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_digraph" class="md-nav__link">
    run_digraph
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters_2" class="md-nav__link">
    Parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#returns-todo" class="md-nav__link">
    Returns : TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#str2bool" class="md-nav__link">
    str2bool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#submit_condor_dag" class="md-nav__link">
    submit_condor_dag
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write_condor_dag" class="md-nav__link">
    write_condor_dag
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../string_db/" title="String Db" class="md-nav__link">
      String Db
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add_file_and_dir_args" class="md-nav__link">
    add_file_and_dir_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#args_to_list" class="md-nav__link">
    args_to_list
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bfs_nodes" class="md-nav__link">
    bfs_nodes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check_file_and_dir_args" class="md-nav__link">
    check_file_and_dir_args
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#format_vars" class="md-nav__link">
    format_vars
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#returns" class="md-nav__link">
    Returns
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get_condor_submit_fp" class="md-nav__link">
    get_condor_submit_fp
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get_exe_path" class="md-nav__link">
    get_exe_path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_revision_number" class="md-nav__link">
    get_revision_number
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#raises" class="md-nav__link">
    Raises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#job_attrs_to_job_name" class="md-nav__link">
    job_attrs_to_job_name
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#log_script" class="md-nav__link">
    log_script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters_1" class="md-nav__link">
    Parameters
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mkdir_p" class="md-nav__link">
    mkdir_p
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parse_condor_submit_stdout" class="md-nav__link">
    parse_condor_submit_stdout
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#returns_1" class="md-nav__link">
    Returns
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo_1" class="md-nav__link">
    TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_command" class="md-nav__link">
    run_command
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keyword-arguments" class="md-nav__link">
    Keyword Arguments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo_2" class="md-nav__link">
    TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run_command_cp" class="md-nav__link">
    run_command_cp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run_digraph" class="md-nav__link">
    run_digraph
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parameters_2" class="md-nav__link">
    Parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#returns-todo" class="md-nav__link">
    Returns : TODO
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#str2bool" class="md-nav__link">
    str2bool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#submit_condor_dag" class="md-nav__link">
    submit_condor_dag
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#write_condor_dag" class="md-nav__link">
    write_condor_dag
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/gitter-lab/prmf/edit/master/reference/prmf/script_utils.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="module-prmfscript_utils">Module prmf.script_utils</h1>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">os.path</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">subprocess</span> <span class="kn">as</span> <span class="nn">sp</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>

<span class="kn">import</span> <span class="nn">distutils.spawn</span>

<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="k">def</span> <span class="nf">args_to_list</span><span class="p">(</span><span class="n">args_dict</span><span class="p">):</span>

  <span class="n">rv</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">args_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

    <span class="n">k_cli</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">args_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>

        <span class="n">rv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_cli</span><span class="p">)</span>

        <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">+</span> <span class="n">v</span>

      <span class="k">else</span><span class="p">:</span>

        <span class="n">rv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_cli</span><span class="p">)</span>

        <span class="n">rv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">rv</span>

<span class="k">def</span> <span class="nf">add_file_and_dir_args</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>

  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--infiles&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--outfiles&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--indir&quot;</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--outdir&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_file_and_dir_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

  <span class="c1"># require file mode or directory mode</span>

  <span class="n">do_file</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="n">do_dir</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="n">do_infiles_outdir</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">infiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">outfiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

    <span class="n">do_file</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outfiles</span><span class="p">):</span>

      <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Must provide the same number of infiles and outfiles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">do_file</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">indir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

      <span class="n">do_dir</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">do_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_dir</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">infiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

      <span class="n">do_infiles_outdir</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">do_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">do_infiles_outdir</span><span class="p">:</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Must provide --infiles and --outfiles or provide --indir and --outdir or provide --infiles and --outdir</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>

  <span class="n">io_pairs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="n">do_file</span><span class="p">:</span>

    <span class="n">io_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outfiles</span><span class="p">))</span>

  <span class="k">elif</span> <span class="n">do_dir</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">ifn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">indir</span><span class="p">):</span>

      <span class="n">ifp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">indir</span><span class="p">,</span> <span class="n">ifn</span><span class="p">)</span>

      <span class="n">ofp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">ifn</span><span class="p">)</span>

      <span class="n">io_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ifp</span><span class="p">,</span> <span class="n">ofp</span><span class="p">))</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="c1"># then do_infiles_outdir</span>

    <span class="k">for</span> <span class="n">ifp</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">infiles</span><span class="p">:</span>

      <span class="n">ofp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ifp</span><span class="p">))</span>

      <span class="n">io_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ifp</span><span class="p">,</span> <span class="n">ofp</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">io_pairs</span>

<span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;Run command and throw error if non-zero exit code</span>

<span class="sd">  Keyword Arguments</span>

<span class="sd">  -----------------</span>

<span class="sd">  condor : boolean</span>

<span class="sd">  stdout_fh : io-like</span>

<span class="sd">  stderr_fh : io-like</span>

<span class="sd">  TODO</span>

<span class="sd">  ----</span>

<span class="sd">  change interface to match format_vars</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;condor&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;condor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;condor&#39;</span><span class="p">]):</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;condor_submitter.sh&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>

  <span class="n">stdout_fh</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;stdout&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

    <span class="n">stdout_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;{}.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="n">stdout_fh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span>

  <span class="n">stderr_fh</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;stderr&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

    <span class="n">stderr_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;{}.err&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="n">stderr_fh</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span>

  <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[STATUS] Launching {}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

  <span class="n">complete_proc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_command_cp</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  &quot;Decorator&quot; around run_command to enable checkpointing</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="s1">&#39;no_checkpoint&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;no_checkpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;no_checkpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;no_checkpoint&#39;</span><span class="p">]:</span>

    <span class="n">run_command</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="c1"># identify this command and its arguments (TODO and its environment?) with a hash value</span>

    <span class="n">to_hash</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">hash_v</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_hash</span><span class="p">))</span>

    <span class="n">hash_fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">hash_v</span><span class="p">))</span>

    <span class="c1"># check if command has previously been run successfully</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hash_fp</span><span class="p">):</span>

      <span class="c1"># if so, dont run again</span>

      <span class="k">pass</span>

    <span class="k">else</span><span class="p">:</span>

      <span class="n">run_command</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

      <span class="c1"># if no error from check_call, command successful, write a file indicating this</span>

      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hash_fp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_hash</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_condor_submit_fp</span><span class="p">():</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  TODO</span>

<span class="sd">  ----</span>

<span class="sd">  allow a different environment variable to specify the location of this file</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HOME&quot;</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">home_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Required environment variable: HOME&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="s2">&quot;.condor&quot;</span><span class="p">,</span> <span class="s2">&quot;submitter.sub&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">format_vars</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">exe</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Parameters</span>

<span class="sd">  -------</span>

<span class="sd">  job_id : str</span>

<span class="sd">    Condor DAG job identifier</span>

<span class="sd">  exe : str</span>

<span class="sd">    executable to run</span>

<span class="sd">  args : list of str</span>

<span class="sd">    arguments to exe</span>

<span class="sd">  out : str</span>

<span class="sd">    filepath to write stdout to</span>

<span class="sd">  err : str</span>

<span class="sd">    filepath to write stderr to</span>

<span class="sd">  requirements : str</span>

<span class="sd">    Condor-style requirements statement e.g. &#39;OpSysMajorVer == 7&#39;</span>

<span class="sd">  env : str</span>

<span class="sd">    conda environment to execute job in</span>

<span class="sd">  Returns</span>

<span class="sd">  -------</span>

<span class="sd">  vars_stmt : str</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">VARS_FMT_STR</span> <span class="o">=</span> <span class="s2">&quot;VARS {} executable=</span><span class="se">\&quot;</span><span class="s2">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">exe</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;keyword argument </span><span class="se">\&quot;</span><span class="s2">exe</span><span class="se">\&quot;</span><span class="s2"> is required&quot;</span><span class="p">)</span>

  <span class="n">exe_path</span> <span class="o">=</span> <span class="n">get_exe_path</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>

  <span class="n">exe_condor</span> <span class="o">=</span> <span class="n">exe_path</span> <span class="c1"># command condor will run</span>

  <span class="k">if</span><span class="p">(</span><span class="n">env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

    <span class="n">runner_exe</span> <span class="o">=</span> <span class="s1">&#39;prmf_runner.sh&#39;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="p">,</span>  <span class="n">exe_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>

    <span class="n">exe_condor</span> <span class="o">=</span> <span class="n">get_exe_path</span><span class="p">(</span><span class="n">runner_exe</span><span class="p">)</span>

  <span class="n">vars_stmt</span> <span class="o">=</span> <span class="n">VARS_FMT_STR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">exe_condor</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

  <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="s2">&quot; arguments=</span><span class="se">\&quot;</span><span class="s2">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

  <span class="k">if</span><span class="p">(</span><span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="s2">&quot; output=</span><span class="se">\&quot;</span><span class="s2">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="s2">&quot; error=</span><span class="se">\&quot;</span><span class="s2">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">requirements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="s2">&quot;requirements = </span><span class="se">\&quot;</span><span class="s2">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">vars_stmt</span>

<span class="k">def</span> <span class="nf">get_exe_path</span><span class="p">(</span><span class="n">inpath</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Wrapper around distutils.spawn.find_executable to provide warning if found executable is in cwd</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">exe_path</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">spawn</span><span class="o">.</span><span class="n">find_executable</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">exe_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;desired executable {} is not on the PATH nor is it in the current working directory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inpath</span><span class="p">))</span>

  <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">exe_path</span><span class="p">)</span>

  <span class="n">cwd_exe_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">inpath</span><span class="p">))</span>

  <span class="k">if</span><span class="p">(</span><span class="n">outpath</span> <span class="o">==</span> <span class="n">cwd_exe_path</span><span class="p">):</span>

    <span class="c1"># this exe may surprise some users because find_executable behaves differently from &quot;which&quot; in</span>

    <span class="c1"># this respect: find_executable will also include the current working directory in the search</span>

    <span class="c1"># for the executable</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[warning] found executable {} is in current working directory and may be a different version of {} than found according to the command-line program </span><span class="se">\&quot;</span><span class="s2">which</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">cwd_exe_path</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">outpath</span>

<span class="k">def</span> <span class="nf">job_attrs_to_job_name</span><span class="p">(</span><span class="n">exe</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  http://research.cs.wisc.edu/htcondor/manual/v8.7/2_10DAGMan_Applications.html#SECTION003102100000000000000</span>

<span class="sd">  The JobName can be any string that contains no white space, except for the strings PARENT</span>

<span class="sd">  and CHILD (in upper, lower, or mixed case). JobName also cannot contain special characters</span>

<span class="sd">  (&#39;.&#39;, &#39;+&#39;) which are reserved for system use.</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>

  <span class="n">hash_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exe</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

  <span class="k">try</span><span class="p">:</span>

    <span class="n">hash_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

  <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid args specification for exe {}:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

  <span class="n">job_name</span> <span class="o">=</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

  <span class="k">return</span> <span class="n">job_name</span>

<span class="k">def</span> <span class="nf">write_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">,</span> <span class="n">digraph</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  See run_digraph</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">JOB_FMT_STR</span> <span class="o">=</span> <span class="s2">&quot;JOB {} {}&quot;</span>

  <span class="n">PARENT_FMT_STR</span> <span class="o">=</span> <span class="s2">&quot;PARENT {} CHILD {}&quot;</span>

  <span class="n">int_to_chr_offset</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>

  <span class="n">job_int_to_name</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>

    <span class="c1"># get generic condor job description filepath</span>

    <span class="n">condor_submit_fp</span> <span class="o">=</span> <span class="n">get_condor_submit_fp</span><span class="p">()</span>

    <span class="n">job_order</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">digraph</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">job_int</span> <span class="ow">in</span> <span class="n">job_order</span><span class="p">:</span>

      <span class="c1"># write JOB declaration</span>

      <span class="n">job_attrs</span> <span class="o">=</span> <span class="n">digraph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">job_int</span><span class="p">]</span>

      <span class="n">job_name</span> <span class="o">=</span> <span class="n">job_attrs_to_job_name</span><span class="p">(</span><span class="o">**</span><span class="n">job_attrs</span><span class="p">)</span>

      <span class="n">job_int_to_name</span><span class="p">[</span><span class="n">job_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_name</span>

      <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">JOB_FMT_STR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">condor_submit_fp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="c1"># write VARS declaration</span>

      <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_vars</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="o">**</span><span class="n">job_attrs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">digraph</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">():</span>

      <span class="c1"># write PARENT .. CHILD declaration</span>

      <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PARENT_FMT_STR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_int_to_name</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">job_int_to_name</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">submit_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">):</span>

  <span class="c1"># TODO output files go in cwd or location of dag file</span>

  <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;condor_submit_dag&quot;</span><span class="p">,</span> <span class="n">dag_fp</span><span class="p">]</span>

  <span class="n">sp</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bfs_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>

  <span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">edge_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">bfs_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">source</span><span class="p">))</span>

  <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

  <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edge_list</span><span class="p">:</span>

    <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">node_list</span>

<span class="k">def</span> <span class="nf">run_digraph</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">digraph</span><span class="p">,</span> <span class="n">condor</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">root_node</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exit_on_err</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Run a set of jobs specified by a directed (acyclic) graph</span>

<span class="sd">  Parameters</span>

<span class="sd">  ----------</span>

<span class="sd">  digraph : nx.DiGraph</span>

<span class="sd">    directed graph specifying job execution order; nodes in the graph are assumed to have node</span>

<span class="sd">    attribute &#39;args&#39; which specifies the executable in args[0] and its arguments in args[1:] and node identifiers</span>

<span class="sd">    in [0..n]</span>

<span class="sd">  condor : bool</span>

<span class="sd">    if True, use condor_submitter.sh to submit jobs</span>

<span class="sd">  dry_run : bool</span>

<span class="sd">    if True, do not submit the DAG</span>

<span class="sd">  exit_on_err : bool</span>

<span class="sd">    if True (and condor False), stop execution of digraph when one of the job nodes fails</span>

<span class="sd">  Returns : TODO</span>

<span class="sd">  -------</span>

<span class="sd">  job_ids : list of str</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span><span class="p">(</span><span class="n">condor</span><span class="p">):</span>

    <span class="c1"># then create a DAG description file for Condor</span>

    <span class="n">dag_fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;digraph.dag&quot;</span><span class="p">)</span>

    <span class="c1"># TODO job_ids?</span>

    <span class="n">write_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">,</span> <span class="n">digraph</span><span class="p">)</span>

    <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">dry_run</span><span class="p">):</span>

      <span class="n">submit_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">)</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="c1"># TODO even with the pool it appears only 1 process is running</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">digraph</span> <span class="o">=</span> <span class="n">digraph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># add proc node attr pointing to a Popen object</span>

    <span class="c1">#job_order = bfs_nodes(digraph, root_node)</span>

    <span class="n">job_order</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">digraph</span><span class="p">)</span>

    <span class="n">env_warned</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_order</span><span class="p">:</span>

      <span class="n">job_attrs</span> <span class="o">=</span> <span class="n">digraph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>

      <span class="k">if</span> <span class="s1">&#39;env&#39;</span> <span class="ow">in</span> <span class="n">job_attrs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env_warned</span><span class="p">:</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[WARNING] one or more jobs have an environment specified, but this functionality has only been implemented for condor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">env_warned</span> <span class="o">=</span> <span class="bp">True</span>

      <span class="c1"># wait for any predecessors to finish</span>

      <span class="c1">#preds = digraph.predecessors(job_id)</span>

      <span class="c1">#for pred in preds:</span>

      <span class="c1">#  digraph.node[pred][&#39;async_result&#39;].wait()</span>

      <span class="c1">#sum_v = 0</span>

      <span class="c1">#for exit in pred_exits:</span>

      <span class="c1">#  sum_v += exit</span>

      <span class="c1">#if(sum_v &gt; 0):</span>

      <span class="c1">#  # then a predecessor failed</span>

      <span class="c1">#  raise RuntimeError(&quot;[ERROR] a predecessor to {} failed&quot;.format(digraph.node[job_id][&#39;exe&#39;]))</span>

      <span class="c1"># launch this node&#39;s job</span>

      <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_attrs</span><span class="p">[</span><span class="s1">&#39;exe&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">job_attrs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>

      <span class="n">stdout_fh</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;out&#39;</span> <span class="ow">in</span> <span class="n">job_attrs</span><span class="p">):</span>

        <span class="n">stdout_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_attrs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>

        <span class="n">stdout_fh</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

      <span class="n">stderr_fh</span> <span class="o">=</span> <span class="bp">None</span>

      <span class="k">if</span><span class="p">(</span><span class="s1">&#39;err&#39;</span> <span class="ow">in</span> <span class="n">job_attrs</span><span class="p">):</span>

        <span class="n">stderr_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_attrs</span><span class="p">[</span><span class="s1">&#39;err&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>

        <span class="n">stderr_fh</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

      <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[STATUS] Launching {} &gt; {} 2&gt; {}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">digraph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s1">&#39;exe&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">digraph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]),</span> <span class="n">job_attrs</span><span class="p">[</span><span class="s1">&#39;out&#39;</span><span class="p">],</span> <span class="n">job_attrs</span><span class="p">[</span><span class="s1">&#39;err&#39;</span><span class="p">]))</span>

      <span class="c1">#def callback_for_job(exit_status):</span>

      <span class="c1">#  digraph.node[job_id][&#39;exit&#39;] = exit_status</span>

      <span class="c1">#digraph.node[job_id][&#39;exit&#39;] = None</span>

      <span class="c1"># TODO for some reason providing stdout and stderr breaks everything?</span>

      <span class="c1">#async_result = pool.apply_async(sp.check_call, [args]) #, {&#39;stdout&#39;: stdout_fh, &#39;stderr&#39;: stderr_fh})</span>

      <span class="c1">#digraph.node[job_id][&#39;async_result&#39;] = async_result</span>

      <span class="c1">#async_result.wait()</span>

      <span class="c1"># TODO synchronous only</span>

      <span class="c1">#proc = sp.Popen(args, stdout=stdout_fh, stderr=stderr_fh)</span>

      <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">dry_run</span><span class="p">):</span>

        <span class="n">exit_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">exit_on_err</span><span class="p">:</span>

          <span class="n">exit_code</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

          <span class="n">exit_code</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">job_ids</span>

<span class="k">def</span> <span class="nf">parse_condor_submit_stdout</span><span class="p">(</span><span class="n">stdout</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Returns</span>

<span class="sd">  -------</span>

<span class="sd">  job_id : str</span>

<span class="sd">    job identifier from condor_submit stdout</span>

<span class="sd">  TODO</span>

<span class="sd">  ----</span>

<span class="sd">  are there python bindings for Condor that are more stable than parsing stdout?</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">pass</span>

<span class="k">def</span> <span class="nf">get_revision_number</span><span class="p">():</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Get revision number from git</span>

<span class="sd">  Raises</span>

<span class="sd">  ------</span>

<span class="sd">  CalledProcessError</span>

<span class="sd">    if git command fails to find the revision number this function will propagate the error:</span>

<span class="sd">    we do not handle this exception because reproducibility is too often overlooked</span>

<span class="sd">  ValueError</span>

<span class="sd">    if environment variable CS799_REPO_DIR is not set</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">env_var</span> <span class="o">=</span> <span class="s1">&#39;PRMF_REPO_DIR&#39;</span>

  <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">repo_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing environment variable {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_var</span><span class="p">))</span>

  <span class="n">rev_number</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s2">&quot;get_revision_no.sh&quot;</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">rev_number</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">log_script</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>

  <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">  Parameters</span>

<span class="sd">  ----------</span>

<span class="sd">  argv : list of str</span>

<span class="sd">    return value of sys.argv</span>

<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="c1">#sys.stderr.write(&quot;Revision: {}\n&quot;.format(get_revision_number()))</span>

<span class="k">def</span> <span class="nf">mkdir_p</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>

  <span class="k">try</span><span class="p">:</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>

  <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>

   <span class="k">return</span> <span class="n">v</span>

  <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">True</span>

  <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">False</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;Boolean value expected.&#39;</span><span class="p">)</span>
</code></pre></div>


</details>
<h2 id="functions">Functions</h2>
<h3 id="add_file_and_dir_args">add_file_and_dir_args</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">add_file_and_dir_args</span><span class="p">(</span>
    <span class="n">parser</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">add_file_and_dir_args</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>

  <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="ss">&quot;--infiles&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="k">type</span><span class="o">=</span><span class="n">str</span><span class="p">)</span>

  <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="ss">&quot;--outfiles&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="k">type</span><span class="o">=</span><span class="n">str</span><span class="p">)</span>

  <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="ss">&quot;--indir&quot;</span><span class="p">,</span> <span class="ss">&quot;-i&quot;</span><span class="p">,</span> <span class="k">type</span><span class="o">=</span><span class="n">str</span><span class="p">)</span>

  <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="ss">&quot;--outdir&quot;</span><span class="p">,</span> <span class="ss">&quot;-o&quot;</span><span class="p">,</span> <span class="k">type</span><span class="o">=</span><span class="n">str</span><span class="p">)</span>
</code></pre></div>


</details>
<h3 id="args_to_list">args_to_list</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">args_to_list</span><span class="p">(</span>
    <span class="n">args_dict</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">args_to_list</span><span class="p">(</span><span class="n">args_dict</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">  </span><span class="n">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sorted</span><span class="p">(</span><span class="n">args_dict</span><span class="p">.</span><span class="n">keys</span><span class="p">())</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">keys</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="n">k_cli</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;--&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args_dict</span><span class="o">[</span><span class="n">k</span><span class="o">]</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nl">list</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">rv</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_cli</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="w"></span>

<span class="w">      </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">rv</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_cli</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">rv</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">rv</span><span class="w"></span>
</code></pre></div>


</details>
<h3 id="bfs_nodes">bfs_nodes</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">bfs_nodes</span><span class="p">(</span>
    <span class="n">G</span><span class="p">,</span>
    <span class="n">source</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">bfs_nodes</span><span class="p">(</span><span class="k">G</span><span class="p">,</span> <span class="k">source</span><span class="p">):</span>

  <span class="n">node_list</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">edge_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">nx</span><span class="p">.</span><span class="n">bfs_edges</span><span class="p">(</span><span class="k">G</span><span class="p">,</span> <span class="k">source</span><span class="p">))</span>

  <span class="n">node_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

  <span class="k">for</span> <span class="n">edge</span> <span class="k">in</span> <span class="n">edge_list</span><span class="p">:</span>

    <span class="n">node_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">node_list</span>
</code></pre></div>


</details>
<h3 id="check_file_and_dir_args">check_file_and_dir_args</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">check_file_and_dir_args</span><span class="p">(</span>
    <span class="n">args</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">check_file_and_dir_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

  <span class="o">#</span> <span class="n">require</span> <span class="n">file</span> <span class="k">mode</span> <span class="k">or</span> <span class="n">directory</span> <span class="k">mode</span>

  <span class="n">do_file</span> <span class="o">=</span> <span class="k">False</span>

  <span class="n">do_dir</span> <span class="o">=</span> <span class="k">False</span>

  <span class="n">do_infiles_outdir</span> <span class="o">=</span> <span class="k">False</span>

  <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">infiles</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span> <span class="k">and</span> <span class="n">args</span><span class="p">.</span><span class="n">outfiles</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">:</span>

    <span class="n">do_file</span> <span class="o">=</span> <span class="k">True</span>

    <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">outfiles</span><span class="p">):</span>

      <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;Must provide the same number of infiles and outfiles\n&quot;</span><span class="p">)</span>

      <span class="n">sys</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">not</span> <span class="n">do_file</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">indir</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span> <span class="k">and</span> <span class="n">args</span><span class="p">.</span><span class="n">outdir</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">:</span>

      <span class="n">do_dir</span> <span class="o">=</span> <span class="k">True</span>

  <span class="k">if</span> <span class="k">not</span> <span class="n">do_file</span> <span class="k">and</span> <span class="k">not</span> <span class="n">do_dir</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">infiles</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span> <span class="k">and</span> <span class="n">args</span><span class="p">.</span><span class="n">outdir</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">:</span>

      <span class="n">do_infiles_outdir</span> <span class="o">=</span> <span class="k">True</span>

  <span class="k">if</span> <span class="k">not</span> <span class="n">do_file</span> <span class="k">and</span> <span class="k">not</span> <span class="n">do_dir</span> <span class="k">and</span> <span class="k">not</span> <span class="n">do_infiles_outdir</span><span class="p">:</span>

    <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;Must provide --infiles and --outfiles or provide --indir and --outdir or provide --infiles and --outdir\n&quot;</span><span class="p">)</span>

    <span class="n">sys</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>

  <span class="n">io_pairs</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="n">do_file</span><span class="p">:</span>

    <span class="n">io_pairs</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">zip</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">infiles</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">outfiles</span><span class="p">))</span>

  <span class="n">elif</span> <span class="n">do_dir</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">ifn</span> <span class="k">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">indir</span><span class="p">):</span>

      <span class="n">ifp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">indir</span><span class="p">,</span> <span class="n">ifn</span><span class="p">)</span>

      <span class="n">ofp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">ifn</span><span class="p">)</span>

      <span class="n">io_pairs</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">ifp</span><span class="p">,</span> <span class="n">ofp</span><span class="p">))</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="o">#</span> <span class="k">then</span> <span class="n">do_infiles_outdir</span>

    <span class="k">for</span> <span class="n">ifp</span> <span class="k">in</span> <span class="n">args</span><span class="p">.</span><span class="n">infiles</span><span class="p">:</span>

      <span class="n">ofp</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ifp</span><span class="p">))</span>

      <span class="n">io_pairs</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">ifp</span><span class="p">,</span> <span class="n">ofp</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">io_pairs</span>
</code></pre></div>


</details>
<h3 id="format_vars">format_vars</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">format_vars</span><span class="p">(</span>
    <span class="n">job_id</span><span class="p">,</span>
    <span class="n">exe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>


<h2 id="parameters">Parameters</h2>
<p>job_id : str
  Condor DAG job identifier</p>
<p>exe : str
  executable to run</p>
<p>args : list of str
  arguments to exe</p>
<p>out : str
  filepath to write stdout to</p>
<p>err : str
  filepath to write stderr to</p>
<p>requirements : str
  Condor-style requirements statement e.g. 'OpSysMajorVer == 7'</p>
<p>env : str
  conda environment to execute job in</p>
<h2 id="returns">Returns</h2>
<p>vars_stmt : str</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">format_vars</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">exe</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="k">out</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  Parameters</span>

<span class="ss">  -------</span>

<span class="ss">  job_id : str</span>

<span class="ss">    Condor DAG job identifier</span>

<span class="ss">  exe : str</span>

<span class="ss">    executable to run</span>

<span class="ss">  args : list of str</span>

<span class="ss">    arguments to exe</span>

<span class="ss">  out : str</span>

<span class="ss">    filepath to write stdout to</span>

<span class="ss">  err : str</span>

<span class="ss">    filepath to write stderr to</span>

<span class="ss">  requirements : str</span>

<span class="ss">    Condor-style requirements statement e.g. &#39;OpSysMajorVer == 7&#39;</span>

<span class="ss">  env : str</span>

<span class="ss">    conda environment to execute job in</span>

<span class="ss">  Returns</span>

<span class="ss">  -------</span>

<span class="ss">  vars_stmt : str</span>

<span class="ss">  &quot;&quot;&quot;</span>

  <span class="n">VARS_FMT_STR</span> <span class="o">=</span> <span class="ss">&quot;VARS {} executable=\&quot;</span><span class="err">{}\</span><span class="ss">&quot;&quot;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">exe</span> <span class="k">is</span> <span class="k">None</span><span class="p">):</span>

    <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;keyword argument \&quot;</span><span class="n">exe</span><span class="err">\</span><span class="ss">&quot; is required&quot;</span><span class="p">)</span>

  <span class="n">exe_path</span> <span class="o">=</span> <span class="n">get_exe_path</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>

  <span class="n">exe_condor</span> <span class="o">=</span> <span class="n">exe_path</span> <span class="o">#</span> <span class="n">command</span> <span class="n">condor</span> <span class="n">will</span> <span class="n">run</span>

  <span class="k">if</span><span class="p">(</span><span class="n">env</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">):</span>

    <span class="n">runner_exe</span> <span class="o">=</span> <span class="s1">&#39;prmf_runner.sh&#39;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">env</span><span class="p">,</span>  <span class="n">exe_path</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>

    <span class="n">exe_condor</span> <span class="o">=</span> <span class="n">get_exe_path</span><span class="p">(</span><span class="n">runner_exe</span><span class="p">)</span>

  <span class="n">vars_stmt</span> <span class="o">=</span> <span class="n">VARS_FMT_STR</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">exe_condor</span><span class="p">,</span> <span class="ss">&quot; &quot;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

  <span class="k">if</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="ss">&quot; arguments=\&quot;</span><span class="err">{}\</span><span class="ss">&quot;&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="ss">&quot; &quot;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

  <span class="k">if</span><span class="p">(</span><span class="k">out</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="ss">&quot; output=\&quot;</span><span class="err">{}\</span><span class="ss">&quot;&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="k">out</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="ss">&quot; error=\&quot;</span><span class="err">{}\</span><span class="ss">&quot;&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">requirements</span> <span class="k">is</span> <span class="k">not</span> <span class="k">None</span><span class="p">):</span>

    <span class="n">vars_stmt</span> <span class="o">+=</span> <span class="ss">&quot;requirements = \&quot;</span><span class="err">{}\</span><span class="ss">&quot;&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">vars_stmt</span>
</code></pre></div>


</details>
<h3 id="get_condor_submit_fp">get_condor_submit_fp</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_condor_submit_fp</span><span class="p">(</span>

<span class="p">)</span>
</code></pre></div>


<h2 id="todo">TODO</h2>
<p>allow a different environment variable to specify the location of this file</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">get_condor_submit_fp</span><span class="p">():</span>

  <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  TODO</span>

<span class="ss">  ----</span>

<span class="ss">  allow a different environment variable to specify the location of this file</span>

<span class="ss">  &quot;&quot;&quot;</span>

  <span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="ss">&quot;HOME&quot;</span><span class="p">)</span>

  <span class="k">if</span><span class="p">(</span><span class="n">home_dir</span> <span class="k">is</span> <span class="k">None</span><span class="p">):</span>

    <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Required environment variable: HOME&quot;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="ss">&quot;.condor&quot;</span><span class="p">,</span> <span class="ss">&quot;submitter.sub&quot;</span><span class="p">)</span>
</code></pre></div>


</details>
<h3 id="get_exe_path">get_exe_path</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_exe_path</span><span class="p">(</span>
    <span class="n">inpath</span>
<span class="p">)</span>
</code></pre></div>


<p>Wrapper around distutils.spawn.find_executable to provide warning if found executable is in cwd</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">get_exe_path</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  Wrapper around distutils.spawn.find_executable to provide warning if found executable is in cwd</span>

<span class="ss">  &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">  </span><span class="n">exe_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distutils</span><span class="p">.</span><span class="n">spawn</span><span class="p">.</span><span class="n">find_executable</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">exe_path</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">None</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">raise</span><span class="w"> </span><span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;desired executable {} is not on the PATH nor is it in the current working directory&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">inpath</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="n">outpath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">exe_path</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">cwd_exe_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">curdir</span><span class="p">,</span><span class="w"> </span><span class="n">inpath</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">outpath</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cwd_exe_path</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">exe</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">surprise</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">find_executable</span><span class="w"> </span><span class="n">behaves</span><span class="w"> </span><span class="n">differently</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="ss">&quot;which&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="nl">respect</span><span class="p">:</span><span class="w"> </span><span class="n">find_executable</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="k">include</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">search</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">executable</span><span class="w"></span>

<span class="w">    </span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;[warning] found executable {} is in current working directory and may be a different version of {} than found according to the command-line program \&quot;</span><span class="n">which</span><span class="err">\</span><span class="ss">&quot;\n&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="w"> </span><span class="n">cwd_exe_path</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">outpath</span><span class="w"></span>
</code></pre></div>


</details>
<h3 id="get_revision_number">get_revision_number</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_revision_number</span><span class="p">(</span>

<span class="p">)</span>
</code></pre></div>


<p>Get revision number from git</p>
<h2 id="raises">Raises</h2>
<p>CalledProcessError
  if git command fails to find the revision number this function will propagate the error:
  we do not handle this exception because reproducibility is too often overlooked</p>
<p>ValueError
  if environment variable CS799_REPO_DIR is not set</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">get_revision_number</span><span class="p">():</span>

  <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  Get revision number from git</span>

<span class="ss">  Raises</span>

<span class="ss">  ------</span>

<span class="ss">  CalledProcessError</span>

<span class="ss">    if git command fails to find the revision number this function will propagate the error:</span>

<span class="ss">    we do not handle this exception because reproducibility is too often overlooked</span>

<span class="ss">  ValueError</span>

<span class="ss">    if environment variable CS799_REPO_DIR is not set</span>

<span class="ss">  &quot;&quot;&quot;</span>

  <span class="n">env_var</span> <span class="o">=</span> <span class="s1">&#39;PRMF_REPO_DIR&#39;</span>

  <span class="n">repo_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">repo_dir</span> <span class="k">is</span> <span class="k">None</span><span class="p">:</span>

    <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Missing environment variable {}&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_var</span><span class="p">))</span>

  <span class="n">rev_number</span> <span class="o">=</span> <span class="n">sp</span><span class="p">.</span><span class="n">check_output</span><span class="p">([</span><span class="ss">&quot;get_revision_no.sh&quot;</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">rev_number</span><span class="p">.</span><span class="n">rstrip</span><span class="p">()</span>
</code></pre></div>


</details>
<h3 id="job_attrs_to_job_name">job_attrs_to_job_name</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">job_attrs_to_job_name</span><span class="p">(</span>
    <span class="n">exe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>


<p>http://research.cs.wisc.edu/htcondor/manual/v8.7/2_10DAGMan_Applications.html#SECTION003102100000000000000
The JobName can be any string that contains no white space, except for the strings PARENT 
and CHILD (in upper, lower, or mixed case). JobName also cannot contain special characters 
('.', '+') which are reserved for system use.</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">job_attrs_to_job_name</span><span class="p">(</span><span class="n">exe</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="k">out</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="k">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

  <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  http://research.cs.wisc.edu/htcondor/manual/v8.7/2_10DAGMan_Applications.html#SECTION003102100000000000000</span>

<span class="ss">  The JobName can be any string that contains no white space, except for the strings PARENT</span>

<span class="ss">  and CHILD (in upper, lower, or mixed case). JobName also cannot contain special characters</span>

<span class="ss">  (&#39;.&#39;, &#39;+&#39;) which are reserved for system use.</span>

<span class="ss">  &quot;&quot;&quot;</span>

  <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">()</span>

  <span class="n">hash_obj</span><span class="p">.</span><span class="k">update</span><span class="p">(</span><span class="n">exe</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>

  <span class="n">try</span><span class="p">:</span>

    <span class="n">hash_obj</span><span class="p">.</span><span class="k">update</span><span class="p">(</span><span class="ss">&quot; &quot;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">args</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>

  <span class="k">except</span> <span class="n">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>

    <span class="n">raise</span> <span class="n">ValueError</span><span class="p">(</span><span class="ss">&quot;Invalid args specification for exe {}:&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

  <span class="n">job_name</span> <span class="o">=</span> <span class="n">hash_obj</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>

  <span class="k">return</span> <span class="n">job_name</span>
</code></pre></div>


</details>
<h3 id="log_script">log_script</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">log_script</span><span class="p">(</span>
    <span class="n">argv</span>
<span class="p">)</span>
</code></pre></div>


<h2 id="parameters_1">Parameters</h2>
<p>argv : list of str
  return value of sys.argv</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">log_script</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>

  <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  Parameters</span>

<span class="ss">  ----------</span>

<span class="ss">  argv : list of str</span>

<span class="ss">    return value of sys.argv</span>

<span class="ss">  &quot;&quot;&quot;</span>

  <span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot; &quot;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">+</span> <span class="ss">&quot;\n&quot;</span><span class="p">)</span>
</code></pre></div>


</details>
<h3 id="mkdir_p">mkdir_p</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">mkdir_p</span><span class="p">(</span>
    <span class="n">dirpath</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">mkdir_p</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>

  <span class="n">try</span><span class="p">:</span>

    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>

  <span class="k">except</span> <span class="n">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

    <span class="n">pass</span>
</code></pre></div>


</details>
<h3 id="parse_condor_submit_stdout">parse_condor_submit_stdout</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">parse_condor_submit_stdout</span><span class="p">(</span>
    <span class="n">stdout</span>
<span class="p">)</span>
</code></pre></div>


<h2 id="returns_1">Returns</h2>
<p>job_id : str
  job identifier from condor_submit stdout</p>
<h2 id="todo_1">TODO</h2>
<p>are there python bindings for Condor that are more stable than parsing stdout?</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">parse_condor_submit_stdout</span><span class="p">(</span><span class="k">stdout</span><span class="p">):</span>

  <span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  Returns</span>

<span class="ss">  -------</span>

<span class="ss">  job_id : str</span>

<span class="ss">    job identifier from condor_submit stdout</span>

<span class="ss">  TODO</span>

<span class="ss">  ----</span>

<span class="ss">  are there python bindings for Condor that are more stable than parsing stdout?</span>

<span class="ss">  &quot;&quot;&quot;</span>

  <span class="n">pass</span>
</code></pre></div>


</details>
<h3 id="run_command">run_command</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span>
    <span class="n">outdir</span><span class="p">,</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>


<p>Run command and throw error if non-zero exit code</p>
<h2 id="keyword-arguments">Keyword Arguments</h2>
<p>condor : boolean
stdout_fh : io-like
stderr_fh : io-like</p>
<h2 id="todo_2">TODO</h2>
<p>change interface to match format_vars</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">run_command</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="ss">&quot;&quot;&quot;Run command and throw error if non-zero exit code</span>

<span class="ss">  Keyword Arguments</span>

<span class="ss">  -----------------</span>

<span class="ss">  condor : boolean</span>

<span class="ss">  stdout_fh : io-like</span>

<span class="ss">  stderr_fh : io-like</span>

<span class="ss">  TODO</span>

<span class="ss">  ----</span>

<span class="ss">  change interface to match format_vars</span>

<span class="ss">  &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="s1">&#39;condor&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">kwargs</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;condor&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">  </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">cmd</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;condor&#39;</span><span class="o">]</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;condor_submitter.sh&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">args</span><span class="w"></span>

<span class="w">  </span><span class="n">stdout_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="s1">&#39;stdout&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">kwargs</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="n">stdout_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;{}.out&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)),</span><span class="w"> </span><span class="ss">&quot;w&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">stdout_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;stdout&#39;</span><span class="o">]</span><span class="w"></span>

<span class="w">  </span><span class="n">stderr_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="s1">&#39;stderr&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">kwargs</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="n">stderr_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;{}.err&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)),</span><span class="w"> </span><span class="ss">&quot;w&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">stderr_fh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;stderr&#39;</span><span class="o">]</span><span class="w"></span>

<span class="w">  </span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;[STATUS] Launching {}\n&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span><span class="w"></span>

<span class="w">  </span><span class="n">complete_proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


</details>
<h3 id="run_command_cp">run_command_cp</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run_command_cp</span><span class="p">(</span>
    <span class="n">outdir</span><span class="p">,</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>


<p>"Decorator" around run_command to enable checkpointing</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">run_command_cp</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  &quot;</span><span class="n">Decorator</span><span class="ss">&quot; around run_command to enable checkpointing</span>

<span class="ss">  &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;no_checkpoint&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">kwargs</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;no_checkpoint&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"></span>

<span class="w">  </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;no_checkpoint&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">kwargs</span><span class="o">[</span><span class="n">&#39;no_checkpoint&#39;</span><span class="o">]</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="n">run_command</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">identify</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="p">(</span><span class="n">TODO</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">environment</span><span class="vm">?</span><span class="p">)</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="k">value</span><span class="w"></span>

<span class="w">    </span><span class="n">to_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">cmd</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">hash_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash</span><span class="p">(</span><span class="ss">&quot;&quot;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">to_hash</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="n">hash_fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">hash_v</span><span class="p">))</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">previously</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">successfully</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="ow">exists</span><span class="p">(</span><span class="n">hash_fp</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">so</span><span class="p">,</span><span class="w"> </span><span class="n">dont</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">again</span><span class="w"></span>

<span class="w">      </span><span class="n">pass</span><span class="w"></span>

<span class="w">    </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">      </span><span class="n">run_command</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">check_call</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">successful</span><span class="p">,</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">indicating</span><span class="w"> </span><span class="n">this</span><span class="w"></span>

<span class="w">      </span><span class="k">with</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">hash_fp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">fh</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">fh</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;\t&quot;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">to_hash</span><span class="p">))</span><span class="w"></span>
</code></pre></div>


</details>
<h3 id="run_digraph">run_digraph</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">run_digraph</span><span class="p">(</span>
    <span class="n">outdir</span><span class="p">,</span>
    <span class="n">digraph</span><span class="p">,</span>
    <span class="n">condor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">root_node</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">exit_on_err</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span>
</code></pre></div>


<p>Run a set of jobs specified by a directed (acyclic) graph</p>
<h2 id="parameters_2">Parameters</h2>
<p>digraph : nx.DiGraph
  directed graph specifying job execution order; nodes in the graph are assumed to have node
  attribute 'args' which specifies the executable in args[0] and its arguments in args[1:] and node identifiers
  in [0..n]</p>
<p>condor : bool
  if True, use condor_submitter.sh to submit jobs</p>
<p>dry_run : bool
  if True, do not submit the DAG</p>
<p>exit_on_err : bool
  if True (and condor False), stop execution of digraph when one of the job nodes fails</p>
<h2 id="returns-todo">Returns : TODO</h2>
<p>job_ids : list of str</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">run_digraph</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="n">digraph</span><span class="p">,</span><span class="w"> </span><span class="n">condor</span><span class="o">=</span><span class="k">False</span><span class="p">,</span><span class="w"> </span><span class="n">dry_run</span><span class="o">=</span><span class="k">False</span><span class="p">,</span><span class="w"> </span><span class="n">root_node</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">exit_on_err</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  Run a set of jobs specified by a directed (acyclic) graph</span>

<span class="ss">  Parameters</span>

<span class="ss">  ----------</span>

<span class="ss">  digraph : nx.DiGraph</span>

<span class="ss">    directed graph specifying job execution order; nodes in the graph are assumed to have node</span>

<span class="ss">    attribute &#39;args&#39; which specifies the executable in args[0] and its arguments in args[1:] and node identifiers</span>

<span class="ss">    in [0..n]</span>

<span class="ss">  condor : bool</span>

<span class="ss">    if True, use condor_submitter.sh to submit jobs</span>

<span class="ss">  dry_run : bool</span>

<span class="ss">    if True, do not submit the DAG</span>

<span class="ss">  exit_on_err : bool</span>

<span class="ss">    if True (and condor False), stop execution of digraph when one of the job nodes fails</span>

<span class="ss">  Returns : TODO</span>

<span class="ss">  -------</span>

<span class="ss">  job_ids : list of str</span>

<span class="ss">  &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">  </span><span class="n">job_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">[]</span><span class="w"></span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">condor</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">DAG</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Condor</span><span class="w"></span>

<span class="w">    </span><span class="n">dag_fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="k">path</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;digraph.dag&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">job_ids</span><span class="vm">?</span><span class="w"></span>

<span class="w">    </span><span class="n">write_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">,</span><span class="w"> </span><span class="n">digraph</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="ow">not</span><span class="w"> </span><span class="n">dry_run</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">      </span><span class="n">submit_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">even</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">appears</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">running</span><span class="w"></span>

<span class="w">    </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mp</span><span class="p">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">mp</span><span class="p">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">digraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digraph</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">proc</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="n">pointing</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Popen</span><span class="w"> </span><span class="k">object</span><span class="w"></span>

<span class="w">    </span><span class="n">#job_order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bfs_nodes</span><span class="p">(</span><span class="n">digraph</span><span class="p">,</span><span class="w"> </span><span class="n">root_node</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">job_order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nx</span><span class="p">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">digraph</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="n">env_warned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">False</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">job_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">job_order</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="n">job_attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digraph</span><span class="p">.</span><span class="n">node</span><span class="o">[</span><span class="n">job_id</span><span class="o">]</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;env&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">job_attrs</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nl">env_warned</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;[WARNING] one or more jobs have an environment specified, but this functionality has only been implemented for condor\n&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="n">env_warned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="ow">any</span><span class="w"> </span><span class="n">predecessors</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">finish</span><span class="w"></span>

<span class="w">      </span><span class="n">#preds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digraph</span><span class="p">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="n">#for</span><span class="w"> </span><span class="n">pred</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">preds</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w">  </span><span class="n">digraph</span><span class="p">.</span><span class="n">node</span><span class="o">[</span><span class="n">pred</span><span class="o">][</span><span class="n">&#39;async_result&#39;</span><span class="o">]</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span><span class="w"></span>

<span class="w">      </span><span class="n">#sum_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="w">      </span><span class="n">#for</span><span class="w"> </span><span class="k">exit</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">pred_exits</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w">  </span><span class="n">sum_v</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">exit</span><span class="w"></span>

<span class="w">      </span><span class="n">#if</span><span class="p">(</span><span class="n">sum_v</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">predecessor</span><span class="w"> </span><span class="n">failed</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w">  </span><span class="n">raise</span><span class="w"> </span><span class="n">RuntimeError</span><span class="p">(</span><span class="ss">&quot;[ERROR] a predecessor to {} failed&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">digraph</span><span class="p">.</span><span class="n">node</span><span class="o">[</span><span class="n">job_id</span><span class="o">][</span><span class="n">&#39;exe&#39;</span><span class="o">]</span><span class="p">))</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">node</span><span class="s1">&#39;s job</span>

<span class="s1">      args = [job_attrs[&#39;</span><span class="n">exe</span><span class="s1">&#39;]] + job_attrs[&#39;</span><span class="n">args</span><span class="s1">&#39;]</span>

<span class="s1">      stdout_fh = None</span>

<span class="s1">      if(&#39;</span><span class="k">out</span><span class="s1">&#39; in job_attrs):</span>

<span class="s1">        stdout_fh = open(job_attrs[&#39;</span><span class="k">out</span><span class="s1">&#39;], &#39;</span><span class="n">w</span><span class="s1">&#39;)</span>

<span class="s1">      else:</span>

<span class="s1">        stdout_fh = sys.stdout</span>

<span class="s1">      stderr_fh = None</span>

<span class="s1">      if(&#39;</span><span class="n">err</span><span class="s1">&#39; in job_attrs):</span>

<span class="s1">        stderr_fh = open(job_attrs[&#39;</span><span class="n">err</span><span class="s1">&#39;], &#39;</span><span class="n">w</span><span class="s1">&#39;)</span>

<span class="s1">      else:</span>

<span class="s1">        stderr_fh = sys.stderr</span>

<span class="s1">      sys.stdout.write(&quot;[STATUS] Launching {} &gt; {} 2&gt; {}\n&quot;.format(&quot; &quot;.join([digraph.node[job_id][&#39;</span><span class="n">exe</span><span class="s1">&#39;]] + digraph.node[job_id][&#39;</span><span class="n">args</span><span class="s1">&#39;]), job_attrs[&#39;</span><span class="k">out</span><span class="s1">&#39;], job_attrs[&#39;</span><span class="n">err</span><span class="s1">&#39;]))</span>

<span class="s1">      #def callback_for_job(exit_status):</span>

<span class="s1">      #  digraph.node[job_id][&#39;</span><span class="k">exit</span><span class="s1">&#39;] = exit_status</span>

<span class="s1">      #digraph.node[job_id][&#39;</span><span class="k">exit</span><span class="s1">&#39;] = None</span>

<span class="s1">      # TODO for some reason providing stdout and stderr breaks everything?</span>

<span class="s1">      #async_result = pool.apply_async(sp.check_call, [args]) #, {&#39;</span><span class="n">stdout</span><span class="s1">&#39;: stdout_fh, &#39;</span><span class="n">stderr</span><span class="s1">&#39;: stderr_fh})</span>

<span class="s1">      #digraph.node[job_id][&#39;</span><span class="n">async_result</span><span class="err">&#39;]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async_result</span><span class="w"></span>

<span class="w">      </span><span class="n">#async_result</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="n">synchronous</span><span class="w"> </span><span class="k">only</span><span class="w"></span>

<span class="w">      </span><span class="n">#proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="ow">not</span><span class="w"> </span><span class="n">dry_run</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">        </span><span class="n">exit_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nl">exit_on_err</span><span class="p">:</span><span class="w"></span>

<span class="w">          </span><span class="n">exit_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>

<span class="w">          </span><span class="n">exit_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">.</span><span class="k">call</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fh</span><span class="p">,</span><span class="w"> </span><span class="n">stderr</span><span class="o">=</span><span class="n">stderr_fh</span><span class="p">)</span><span class="w"></span>

<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">job_ids</span><span class="w"></span>
</code></pre></div>


</details>
<h3 id="str2bool">str2bool</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span>
    <span class="n">v</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>

  <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">bool</span><span class="p">):</span>

   <span class="k">return</span> <span class="n">v</span>

  <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="k">lower</span><span class="p">()</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>

    <span class="k">return</span> <span class="k">True</span>

  <span class="n">elif</span> <span class="n">v</span><span class="p">.</span><span class="k">lower</span><span class="p">()</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>

    <span class="k">return</span> <span class="k">False</span>

  <span class="k">else</span><span class="p">:</span>

    <span class="n">raise</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;Boolean value expected.&#39;</span><span class="p">)</span>
</code></pre></div>


</details>
<h3 id="submit_condor_dag">submit_condor_dag</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">submit_condor_dag</span><span class="p">(</span>
    <span class="n">dag_fp</span>
<span class="p">)</span>
</code></pre></div>


<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">submit_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">TODO</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">cwd</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">dag</span><span class="w"> </span><span class="k">file</span><span class="w"></span>

<span class="w">  </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&quot;condor_submit_dag&quot;, dag_fp</span><span class="o">]</span><span class="w"></span>

<span class="w">  </span><span class="n">sp</span><span class="p">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


</details>
<h3 id="write_condor_dag">write_condor_dag</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">write_condor_dag</span><span class="p">(</span>
    <span class="n">dag_fp</span><span class="p">,</span>
    <span class="n">digraph</span>
<span class="p">)</span>
</code></pre></div>


<p>See run_digraph</p>
<details class="example"><summary>View Source</summary><div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">write_condor_dag</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">,</span><span class="w"> </span><span class="n">digraph</span><span class="p">)</span><span class="err">:</span><span class="w"></span>

<span class="w">  </span><span class="ss">&quot;&quot;&quot;</span>

<span class="ss">  See run_digraph</span>

<span class="ss">  &quot;&quot;&quot;</span><span class="w"></span>

<span class="w">  </span><span class="n">JOB_FMT_STR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;JOB {} {}&quot;</span><span class="w"></span>

<span class="w">  </span><span class="n">PARENT_FMT_STR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;PARENT {} CHILD {}&quot;</span><span class="w"></span>

<span class="w">  </span><span class="n">int_to_chr_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="n">job_int_to_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{}</span><span class="w"></span>

<span class="w">  </span><span class="k">with</span><span class="w"> </span><span class="k">open</span><span class="p">(</span><span class="n">dag_fp</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;w&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">fh</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="n">condor</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="n">filepath</span><span class="w"></span>

<span class="w">    </span><span class="n">condor_submit_fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_condor_submit_fp</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">job_order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nx</span><span class="p">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">digraph</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">job_int</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">job_order</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="n">JOB</span><span class="w"> </span><span class="n">declaration</span><span class="w"></span>

<span class="w">      </span><span class="n">job_attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">digraph</span><span class="p">.</span><span class="n">node</span><span class="o">[</span><span class="n">job_int</span><span class="o">]</span><span class="w"></span>

<span class="w">      </span><span class="n">job_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job_attrs_to_job_name</span><span class="p">(</span><span class="o">**</span><span class="n">job_attrs</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="n">job_int_to_name</span><span class="o">[</span><span class="n">job_int</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">job_name</span><span class="w"></span>

<span class="w">      </span><span class="n">fh</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">JOB_FMT_STR</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="w"> </span><span class="n">condor_submit_fp</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="n">VARS</span><span class="w"> </span><span class="n">declaration</span><span class="w"></span>

<span class="w">      </span><span class="n">fh</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">format_vars</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">job_attrs</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">edge</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">digraph</span><span class="p">.</span><span class="n">edges_iter</span><span class="p">()</span><span class="err">:</span><span class="w"></span>

<span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">write</span><span class="w"> </span><span class="n">PARENT</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="n">CHILD</span><span class="w"> </span><span class="n">declaration</span><span class="w"></span>

<span class="w">      </span><span class="n">fh</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="n">PARENT_FMT_STR</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">job_int_to_name</span><span class="o">[</span><span class="n">edge[0</span><span class="o">]</span><span class="err">]</span><span class="p">,</span><span class="w"> </span><span class="n">job_int_to_name</span><span class="o">[</span><span class="n">edge[1</span><span class="o">]</span><span class="err">]</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">&quot;\n&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>


</details>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../prmf_args/" title="Prmf Args" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Prmf Args
              </span>
            </div>
          </a>
        
        
          <a href="../string_db/" title="String Db" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                String Db
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Powered by
        <a href="http://timothycrosley.github.io/portray">portray.</a>
        You too can
        <a href="http://timothycrosley.github.io/portray">
          portray</a>
        your Python project well using automatic documentation.
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../../.."}})</script>
      
    
  </body>
</html>